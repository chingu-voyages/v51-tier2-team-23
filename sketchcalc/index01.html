<html>
    <style>
        table, th, td{
            border:1px solid black;
        }
        td{
            height: 20px;
            width: auto;
        }
        input[type="number"]{
            display:none;
        }
    </style>
    <body>
        <div>
            <h5>Total</h5>
            <div id="tot">10000</div>
        </div>
        <form id="calcForm" action="">
            <table>
                <tr>
                    <th>Fix</th>
                    <th>Name</th>
                    <th>% Current Split</th>
                    <th>Expected Contr</th>
                    <th>Paid</th>
                    <th>Remain</th>
                    <th>Remain %</th>
                </tr>
                <tr>
                    <form id="fixcol">
                        <td class="fix selcol" data-columns="1" data-rows="0"></td>
                        <td class="name selcol" data-columns="2" data-rows="0"></td>
                        <td class="split selcol" data-columns="3" data-rows="0"><input type="radio" id="m03" name="fixcol" value="col3"></td>
                        <td class="econtr selcol" data-columns="4" data-rows="0"><input type="radio" id="m04" name="fixcol" value="col4"></td>
                        <td class="paid selcol" data-columns="5" data-rows="0"><input type="radio" id="m05" name="fixcol" value="col5"></td>
                        <td class="remain selcol" data-columns="6" data-rows="0"></td>
                        <td class="remperc selcol" data-columns="7" data-rows="0"></td>
                        <input id="m0fixcol" type="button" value="fixcol" onclick="updateCol()">
                    </form>
                </tr>
                <tr>
                    <td class="fix" data-columns="1" data-rows="1"><input type="checkbox" id="m11fixr" name="row1" value="row1"></td>
                    <td class="name" data-columns="2" data-rows="1">Que</td>
                    <td class="split" data-columns="3" data-rows="1"><input type="number" name="spl" id="m13in" min="0" max="100"><span id="m13out"></span></td>
                    <td class="econtr" data-columns="4" data-rows="1"><input type="number" name="contr" id="m14in" min="0" max="1000000"><span id="m14out"></span></td>
                    <td class="paid" data-columns="5" data-rows="1"><input type="number" name="paidin" id="m15in" min="0" max="1000000"><span id="m15out"></span></td>
                    <td class="remain" data-columns="6" data-rows="1"><span id="m16out"></span></td>
                    <td class="remperc" data-columns="7" data-rows="1"><span id="m17out"></span></td>
                </tr>
                <tr>
                    <td class="fix" data-columns="1" data-rows="2"><input type="checkbox" id="m21fixr" name="row2" value="row2"></td>
                    <td class="name" data-columns="2" data-rows="2">Cuando</td>
                    <td class="split" data-columns="3" data-rows="2"><input type="number" name="spl" id="m23in" min="0" max="100"><span id="m23out"></span></td>
                    <td class="econtr" data-columns="4" data-rows="2"><input type="number" name="contr" id="m24in" min="0" max="1000000"><span id="m24out"></span></td>
                    <td class="paid" data-columns="5" data-rows="2"><input type="number" name="paidin" id="m25in" min="0" max="1000000"><span id="m25out"></span></td>
                    <td class="remain" data-columns="6" data-rows="2"><span id="m26out"></span></td>
                    <td class="remperc" data-columns="7" data-rows="2"><span id="m27out"></span></td>
                </tr>
                <tr>
                    <td class="fix" data-columns="1" data-rows="3"><input type="checkbox" id="m31fixr" name="row3" value="row3"></td>
                    <td class="name" data-columns="2" data-rows="3">Como</td>
                    <td class="split" data-columns="3" data-rows="3"><input type="number" name="spl" id="m33in" min="0" max="100"><span id="m33out"></span></td>
                    <td class="econtr" data-columns="4" data-rows="3"><input type="number" name="contr" id="m34in" min="0" max="1000000"><span id="m34out"></span></td>
                    <td class="paid" data-columns="5" data-rows="3"><input type="number" name="paidin" id="m35in" min="0" max="1000000"><span id="m35out"></span></td>
                    <td class="remain" data-columns="6" data-rows="3"><span id="m36out"></span></td>
                    <td class="remperc" data-columns="7" data-rows="3"><span id="m37out"></span></td>
                </tr>
                <tr>
                    <td class="fix" data-columns="1" data-rows="4"><input type="checkbox" id="m41fixr" name="row4" value="row4"></td>
                    <td class="name" data-columns="2" data-rows="4">Quien</td>
                    <td class="split" data-columns="3" data-rows="4"><input type="number" name="spl" id="m43in" min="0" max="100"><span id="m43out"></span></td>
                    <td class="econtr" data-columns="4" data-rows="4"><input type="number" name="contr" id="m44in" min="0" max="1000000"><span id="m44out"></span></td>
                    <td class="paid" data-columns="5" data-rows="4"><input type="number" name="paidin" id="m45in" min="0" max="1000000"><span id="m45out"></span></td>
                    <td class="remain" data-columns="6" data-rows="4"><span id="m46out"></span></td>
                    <td class="remperc" data-columns="7" data-rows="4"><span id="m47out"></span></td>
                </tr>
            </table>
            <input id="m0form" type="button" value="form" onclick="update()">
        </form>
    </body>
    <script>

        //TODO: change all the project so it is based on dataset attribute instead of ids or values? What happens if one of the participant leaves the group?
        //https://developer.mozilla.org/en-US/docs/Learn/HTML/Howto/Use_data_attributes
        //https://stackoverflow.com/questions/11563638/how-do-i-get-the-value-of-text-input-field-using-javascript

        const cTot = Number(document.getElementById("tot").innerHTML);
        let init = function(){
            let eqCon = cTot/4;
            let eqPer = eqCon*100/cTot;
            let outputAll = document.getElementsByTagName("span");
            for(let i = 0; i < outputAll.length; i++){
                if((outputAll[i].id).includes('4out') || (outputAll[i].id).includes('6out')){
                    outputAll[i].innerHTML = String(eqCon);
                }else if((outputAll[i].id).includes('3out') || (outputAll[i].id).includes('7out')){
                    outputAll[i].innerHTML = String(eqPer);
                }
            }
        }

        let updateCol = function(){
            let inputAll = document.getElementsByTagName("input");
            let radios = document.querySelectorAll('input[type="radio"]');
            let checkboxs =document.querySelectorAll('input[type="checkbox"]');
            let checkedboxs = !checkboxs? [] : Array.from(checkboxs).filter((cbox,i)=>{return cbox.checked;}).map((v,i)=>{return v.value.substr(-1)});
            let checkedradio = !radios? [] : Array.from(radios).filter((r,i)=>{return r.checked;}).map((v,i)=>{return v.value.substr(-1)});
            //console.log(checkedboxs, checkedradio);

            let rowscols = checkedboxs.map((v,i)=>{ if(v){
                        return v+checkedradio[0];
                    }});
            //console.log(rowscols);

            for(let i = 0; i < inputAll.length; i++){

                //update all inputs to close
                if(!(inputAll[i].value).includes('row') && !(inputAll[i].value).includes('col') && !(inputAll[i].value).includes('form')){
                    inputAll[i].style.display = 'none';
                }                
                
                //open only those required
                if(checkedboxs.length > 0 && checkedradio.length > 0){
                    for(let j = 0; j < rowscols.length; j++){
                        if((inputAll[i].id).includes(rowscols[j] + 'in')){
                            inputAll[i].style.display = 'inline-block';
                        }
                    }
                }
            }


            //for (let radio of radios) {
            //    if (radio.checked) {
            //        for(let i = 0; i < inputAll.length; i++){
            //            if((inputAll[i].id).includes(radio.value.substr(-1)+'in') ){
            //                inputAll[i].style.display = 'inline-block';
            //            }else if(!(inputAll[i].value).includes('row') && !(inputAll[i].value).includes('col')){
            //                inputAll[i].style.display = 'none';
            //            }
            //        }
            //    }
            //}
        }

        let update = function(){
            let inputAll = document.getElementsByTagName("input");
            let inputnumb = document.querySelectorAll('input[type="number"]');
            //console.log(contrElemAll);
            let radios = document.querySelectorAll('input[type="radio"]');
            let checkboxs =document.querySelectorAll('input[type="checkbox"]');
            let checkedboxs = !checkboxs? [] : Array.from(checkboxs).filter((cbox,i)=>{return cbox.checked;}).map((v,i)=>{return v.value.substr(-1)});
            let checkedradio = !radios? [] : Array.from(radios).filter((r,i)=>{return r.checked;}).map((v,i)=>{return v.value.substr(-1)});

            let rowscols = checkedboxs.map((v,i)=>{ if(v){
                return v+checkedradio[0];
            }});
            
            //make the calculations always in function of the expected contributions
            //get the current values
            let contrElemAll = document.querySelectorAll(".econtr > span");
            
            //get the new values
            const newContrs = {}
            let numberOfSplits = 0;
            if(checkedboxs.length > 0 && checkedradio.length > 0){ //IF WE HAVE VALID SELECTIONS
                for(let i = 0; i < inputnumb.length; i++){ //THIS WILL VISIT ALL EDITABLE COLUMNs
                    //open only those required
                    //for now, we want to see only those under the opened editable column
                    //console.log(checkedradio[0].substr(-1) + 'in');
                    let iptnumb = inputnumb[i];
                    let iptnumbID = iptnumb.id;
                    if(iptnumbID.includes(checkedradio[0].substr(-1) + 'in')){ //IF RECORD IS UNDER THE COLUMN
                        console.log(iptnumbID);
                        newContrs[iptnumbID] = {};
                        newContrs[iptnumbID].contribution =  [Number(iptnumb.value)];
                        console.log(rowscols);
                        let edited = rowscols.map((v,i)=>{return iptnumbID.includes(v)}).filter((v,i)=>{return true}).reduce((acc, b)=>{return acc || b}); //NOW LET'S CHECK IF OPEN
                        console.log('edited', edited);
                        if(edited){
                            newContrs[inputnumb[i].id].edited = true; //IF EDITED
                        }else{
                            newContrs[inputnumb[i].id].edited = false; //IF NOT EDITED
                            numberOfSplits += 1;
                        }
                    }
                }
            }


            //for(let i = 0; i < inputnumb.length; i++){
            //    //open only those required
            //    if(checkedboxs.length > 0 && checkedradio.length > 0){
            //        for(let j = 0; j < rowscols.length; j++){
            //            console.log(inputnumb[i].value);
            //            newContrs[inputnumb[i].id] = {};
            //            newContrs[inputnumb[i].id].contribution =  [Number(inputnumb[i].value)];
            //             if((inputnumb[i].id).includes(rowscols[j] + 'in')){
            //                newContrs[inputnumb[i].id].action = 'edited';
            //            }else{
            //                newContrs[inputnumb[i].id].action = 'split';
            //            }
            //        }
            //    }
            //}

            console.log(Object.keys(newContrs));

            //calculate needed contribution

            //GET THE CURRENT CONTR VALUES AND MAKE A FIRST COLLECTION OF THE DIFFERENCES FOR EDITED VALUES
            for(let i = 0; i < contrElemAll.length; i++){
                //console.log(contrElemAll[i].id.slice(contrElemAll[i].id.length-3, contrElemAll[i].id.length));
                console.log(contrElemAll[i].id.slice(0, contrElemAll[i].id.length-3));
                let idSeg = contrElemAll[i].id.slice(0, contrElemAll[i].id.length-3);
                let idSegIN = idSeg + 'in';
                if(Object.keys(newContrs).includes(idSegIN)){
                    newContrs[idSegIN].contribution.push(Number(contrElemAll[i].innerHTML));
                    if(newContrs[idSegIN].edited){
                        console.log(newContrs[idSegIN].contribution[1]);
                        newContrs[idSegIN].contribution.push(newContrs[idSegIN].contribution[1]-newContrs[idSegIN].contribution[0]);
                    }else{
                        newContrs[idSegIN].contribution.push(0);
                    }
                }
            }

            console.log(newContrs);

            //get sum that should be splitted
            //equally divide that contribution between the rest of the participants
            let sumNewSplit = Object.keys(newContrs).map((k,i)=>{if(newContrs[k].edited){return newContrs[k].contribution[2]}}).filter((v,i)=>{return v != undefined}).reduce((acc, b)=>{return acc+b});

            console.log(sumNewSplit/numberOfSplits);

            for(let key in newContrs){
                //console.log(key, newContrs[key])
                for(let i = 0; i < contrElemAll.length; i++) {
                    if((contrElemAll[i].id).includes(key.slice(0, key.length-2))){
                        if(newContrs[key].edited){
                            contrElemAll[i].innerHTML = newContrs[key].contribution[0];
                        }else{
                            contrElemAll[i].innerHTML = newContrs[key].contribution[1] + sumNewSplit/numberOfSplits;
                        }
                    }
                }             
            }
        }



        //let update = function(){
        //    //<input type="button" value="update" onclick="update()">
        //    let checkCol = document.querySelectorAll("input[name=fixcol]");
        //    console.log(checkCol);
        //}

       window.onload = function(){
            init();
        }
    </script>
</html>